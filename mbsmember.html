<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MBS Member Registration</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root { --main-color: #007bff; --bg-color: #e7f1ff; }
body { background-color: var(--bg-color); transition: 0.5s; font-family: sans-serif; padding: 20px 0; }
.card { background: #fff; border: none; border-top: 10px solid var(--main-color); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 700px; margin: auto; }
input[type="text"], textarea, .form-select { text-transform: uppercase; }
.fixed-country { background-color: #e9ecef !important; font-weight: bold; }
#signature-pad { border: 2px dashed #ccc; background: #fff; width: 100%; height: 200px; }
#reader { width: 100%; display: none; margin-bottom: 10px; }
#loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
</style>
</head>
<body>

<div id="loader">
<div class="spinner-border text-primary"></div>
<div class="mt-3 fw-bold">SEDANG MEMPROSES...</div>
</div>

<div class="container">
<div class="card p-4">
<h3 class="text-center mb-4" style="color: var(--main-color);">MBS MEMBER REGISTRATION</h3>

<form id="regForm">

<div class="mb-3">
<label class="form-label fw-bold">JENIS MEMBER:</label>
<select class="form-select" id="type" onchange="updateTheme()">
<option value="PPS" selected>PPS</option>
<option value="RED">RED</option>
<option value="SKYBLUE">SKYBLUE</option>
<option value="BLACK">BLACK</option>
</select>
</div>

<div class="mb-3">
<label class="form-label fw-bold">MEMBER CARD NO:</label>
<div id="reader"></div>
<div class="input-group">
<input type="text" class="form-control" id="cardNo" required>
<button class="btn btn-outline-secondary" type="button" onclick="startScan()">ðŸ“· SCAN</button>
</div>
</div>

<div class="mb-3">
<label class="form-label fw-bold">NAMA PENUH:</label>
<input type="text" class="form-control" id="nama" required>
</div>

<div class="row">
<div class="col-6 mb-3">
<label class="form-label fw-bold">NOMBOR IC:</label>
<input type="text" class="form-control" id="ic" required>
</div>
<div class="col-6 mb-3">
<label class="form-label fw-bold">HANDPHONE:</label>
<input type="tel" class="form-control" id="phone" required>
</div>
</div>

<div class="mb-3">
<label class="form-label fw-bold">ALAMAT:</label>
<textarea class="form-control" id="alamat" rows="2" required></textarea>
</div>

<div class="row">
<div class="col-4 mb-3">
<label class="form-label fw-bold">POSTCODE:</label>
<input type="text" class="form-control" id="postcode" required>
</div>
<div class="col-4 mb-3">
<label class="form-label fw-bold">CITY:</label>
<input type="text" class="form-control" id="city" required>
</div>
<div class="col-4 mb-3">
<label class="form-label fw-bold">STATE:</label>
<select class="form-select" id="state" required>
<option value="" disabled selected>PILIH NEGERI</option>
<option>JOHOR</option><option>KEDAH</option><option>KELANTAN</option>
<option>MELAKA</option><option>NEGERI SEMBILAN</option><option>PAHANG</option>
<option>PERAK</option><option>PERLIS</option><option>PULAU PINANG</option>
<option>SABAH</option><option>SARAWAK</option><option>SELANGOR</option>
<option>TERENGGANU</option><option>W.P. KUALA LUMPUR</option>
<option>W.P. LABUAN</option><option>W.P. PUTRAJAYA</option>
</select>
</div>
</div>

<div class="mb-3">
<label class="form-label fw-bold">COUNTRY:</label>
<input type="text" class="form-control fixed-country" value="MALAYSIA" readonly>
</div>

<div class="mb-4">
<label class="form-label fw-bold">BIL ANAK MASIH BELAJAR:</label>
<input type="number" class="form-control" id="anak" value="0">
</div>

<button type="button" class="btn btn-primary w-100 py-3" onclick="openSignatureModal()">
SETERUSNYA: PENGESAHAN & SIGN
</button>

</form>
</div>
</div>

<!-- MODAL -->
<div class="modal fade" id="tncModal" tabindex="-1" data-bs-backdrop="static">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-body">

<h5 class="fw-bold">PENGAKUAN & SYARAT</h5>
<div style="height:150px; overflow:auto; font-size:12px; background:#f9f9f9; padding:10px; border:1px solid #ddd; margin-bottom:15px;">
Saya bersetuju untuk menyertai & mematuhi Terma & Syarat Kad Diskaun MBS Books & Stationery.
</div>

<label class="fw-bold mb-2">TANDATANGAN:</label>
<canvas id="signature-pad"></canvas>
<button class="btn btn-link btn-sm text-danger" onclick="signaturePad.clear()">Padam Semula</button>

</div>

<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">BATAL</button>
<button type="button" class="btn btn-primary" onclick="hantarData()">SAHKAN & HANTAR</button>
</div>

</div>
</div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyWu_EnJEJeszS8tWOeACSzg9mlWGHOivWKA70-_7T449Kakqx78CX4jmi_Vf-_Zkw/exec";
let signaturePad;
let html5QrCode;

window.addEventListener("load", function(){
signaturePad = new SignaturePad(document.getElementById("signature-pad"));
});

document.getElementById('tncModal').addEventListener('shown.bs.modal', resizeCanvas);

function resizeCanvas(){
const canvas=document.getElementById("signature-pad");
const ratio=Math.max(window.devicePixelRatio||1,1);
canvas.width=canvas.offsetWidth*ratio;
canvas.height=canvas.offsetHeight*ratio;
canvas.getContext("2d").scale(ratio,ratio);
signaturePad.clear();
}

function updateTheme(){
const t=document.getElementById('type').value;
const themes={
PPS:{main:'#007bff',bg:'#e7f1ff'},
RED:{main:'#dc3545',bg:'#f8d7da'},
SKYBLUE:{main:'#0dcaf0',bg:'#e0f7fa'},
BLACK:{main:'#212529',bg:'#dee2e6'}
};
document.documentElement.style.setProperty('--main-color',themes[t].main);
document.documentElement.style.setProperty('--bg-color',themes[t].bg);
}

function startScan(){
const reader=document.getElementById('reader');
reader.style.display='block';
html5QrCode=new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(devices=>{
let back=devices.find(d=>d.label.toLowerCase().includes('back'));
const cameraId=back?back.id:devices[devices.length-1].id;

html5QrCode.start(cameraId,{fps:10,qrbox:{width:250,height:150}},
(decodedText)=>{
document.getElementById('cardNo').value=decodedText;
stopScan();
});
}).catch(err=>alert("Kamera tidak dibenarkan."));
}

function stopScan(){
if(html5QrCode){
html5QrCode.stop().then(()=>{document.getElementById('reader').style.display='none';});
}
}

function openSignatureModal(){
const form=document.getElementById('regForm');
if(!form.checkValidity()) return form.reportValidity();
new bootstrap.Modal(document.getElementById('tncModal')).show();
}

function downloadPDF(data){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.setFontSize(16);
doc.text("MBS MEMBER REGISTRATION",20,20);
doc.setFontSize(12);
doc.text("Nama: "+data.nama,20,40);
doc.text("No Kad: "+data.cardNo,20,50);
doc.text("IC: "+data.ic,20,60);
doc.text("Phone: "+data.phone,20,70);
doc.text("Alamat: "+data.alamat,20,80);
doc.text("State: "+data.state,20,90);
doc.addImage(data.signature,"PNG",20,110,60,30);
doc.save("MBS_"+data.cardNo+".pdf");
}

async function hantarData(){
if(signaturePad.isEmpty()) return alert("Sila turunkan tandatangan!");

document.getElementById('loader').style.display='flex';

const data={
type:type.value,
cardNo:cardNo.value,
nama:nama.value,
ic:ic.value,
phone:phone.value,
alamat:alamat.value,
postcode:postcode.value,
city:city.value,
state:state.value,
anak:anak.value,
signature:signaturePad.toDataURL()
};

try{
await fetch(APPS_SCRIPT_URL,{
method:"POST",
body:JSON.stringify(data),
mode:"no-cors"
});

downloadPDF(data);

alert("PENDAFTARAN BERJAYA!");
setTimeout(()=>location.reload(),2000);

}catch(e){
alert("Sistem sedang memproses...");
location.reload();
}
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
